
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTPolyNet.runtime &#8212; HTPolyNet 1.0.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for HTPolyNet.runtime</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">.. module:: runtime</span>
<span class="sd">   :synopsis: handles the HTPolyNet runtime workflow</span>
<span class="sd">   </span>
<span class="sd">.. moduleauthor: Cameron F. Abrams, &lt;cfa22@drexel.edu&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.configuration</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.topology</span> <span class="kn">import</span> <span class="n">select_topology_type_option</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.topocoord</span> <span class="kn">import</span> <span class="n">TopoCoord</span>
<span class="kn">import</span> <span class="nn">HTPolyNet.projectfilesystem</span> <span class="k">as</span> <span class="nn">pfs</span>
<span class="kn">import</span> <span class="nn">HTPolyNet.software</span> <span class="k">as</span> <span class="nn">software</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.gromacs</span> <span class="kn">import</span> <span class="n">insert_molecules</span><span class="p">,</span> <span class="n">mdp_modify</span><span class="p">,</span> <span class="n">mdp_get</span>
<span class="kn">import</span> <span class="nn">HTPolyNet.checkpoint</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.plot</span> <span class="kn">import</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.molecule</span> <span class="kn">import</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">MoleculeDict</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.reaction</span> <span class="kn">import</span> <span class="n">is_reactant</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.expandreactions</span> <span class="kn">import</span> <span class="n">chain_expand_reactions</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.reaction</span> <span class="kn">import</span> <span class="n">reaction_stage</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.curecontroller</span> <span class="kn">import</span> <span class="n">CureController</span><span class="p">,</span> <span class="n">CureState</span>
<span class="kn">from</span> <span class="nn">HTPolyNet.stringthings</span> <span class="kn">import</span> <span class="n">my_logger</span>

<span class="n">logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="logrotate"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.logrotate">[docs]</a><span class="k">def</span> <span class="nf">logrotate</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;logrotate renames any existing log file with name &#39;filename&#39; using a pattern that</span>
<span class="sd">    prevents overwriting any old logs</span>

<span class="sd">    :param filename: name of log file</span>
<span class="sd">    :type filename: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">#</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;#</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">#</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="n">_directives</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span><span class="s1">&#39;nsteps&#39;</span><span class="p">,</span><span class="s1">&#39;ncycles&#39;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">_nonempty_directives</span><span class="p">(</span><span class="n">dirlist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_nonempty_directives checks the list of directives for existence of at least</span>
<span class="sd">    one of the strings in the _directives list</span>

<span class="sd">    :param dirlist: list of dictionaries</span>
<span class="sd">    :type dirlist: lsit</span>
<span class="sd">    :return: True if one of the strings in _directives is present in one of the dictionaries</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">amts</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirlist</span><span class="p">:</span>
        <span class="n">ta</span><span class="o">=</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_directives</span><span class="p">]</span>
        <span class="n">amts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">ta</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">amts</span><span class="p">)</span>

<div class="viewcode-block" id="Runtime"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime">[docs]</a><span class="k">class</span> <span class="nc">Runtime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Runtime class manages all aspects of a system build using HTPolyNet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_edict</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;nsteps&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="n">runtime_defaults</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;gmx&#39;</span><span class="p">:</span> <span class="s1">&#39;gmx&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gmx_options&#39;</span><span class="p">:</span> <span class="s1">&#39;-quiet -nobackup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mdrun&#39;</span><span class="p">:</span> <span class="s1">&#39;gmx mdrun&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;ambertools&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;charge_method&#39;</span><span class="p">:</span> <span class="s1">&#39;gas&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;densification&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;initial_density&#39;</span><span class="p">:</span> <span class="mf">200.0</span><span class="p">,</span>  <span class="c1"># kg/m3</span>
            <span class="s1">&#39;aspect_ratio&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
            <span class="s1">&#39;equilibration&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;nvt&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">200</span> <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="s1">&#39;precure&#39;</span><span class="p">:</span> <span class="p">{</span>  
            <span class="s1">&#39;preequilibration&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>        <span class="c1"># K</span>
                <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1"># bar</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">100</span>  <span class="c1"># we should probably bring to a desired pressure after densification</span>
            <span class="p">},</span>
            <span class="s1">&#39;anneal&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ncycles&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># default none</span>
                <span class="s1">&#39;initial_temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;cycle_segments&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;postequilibration&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>        <span class="c1"># K</span>
                <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1"># bar</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="c1"># default none</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;CURE&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;postcure&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;anneal&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ncycles&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># default none</span>
                <span class="s1">&#39;initial_temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;cycle_segments&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;postequilibration&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>       <span class="c1"># K</span>
                <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1"># bar</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span>  <span class="mi">0</span> <span class="c1"># default none</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cfgfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;__init__ generates a new Runtime object based on the cfg file</span>

<span class="sd">        :param cfgfile: name of YAML cfg file</span>
<span class="sd">        :type cfgfile: str, optional</span>
<span class="sd">        :param restart: flag indicating if this is a restart</span>
<span class="sd">        :type restart: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="n">software</span><span class="o">.</span><span class="n">to_string</span><span class="p">(),</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile</span><span class="o">=</span><span class="n">cfgfile</span>
        <span class="k">if</span> <span class="n">cfgfile</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;HTPolyNet requires a configuration file.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;HTPolyNet requires a configuration file&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Configuration: </span><span class="si">{</span><span class="n">cfgfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">=</span><span class="n">Configuration</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pfs</span><span class="o">.</span><span class="n">root</span><span class="p">(),</span><span class="n">cfgfile</span><span class="p">))</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Fill in any default values &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">default_values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">default_values</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">default_values</span><span class="p">)</span><span class="o">==</span><span class="nb">dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">default_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">=</span><span class="n">vv</span>
        <span class="n">software</span><span class="o">.</span><span class="n">set_gmx_preferences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">=</span><span class="n">TopoCoord</span><span class="p">(</span><span class="n">system_name</span><span class="o">=</span><span class="s1">&#39;htpolynet&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;restart&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Restarting in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span><span class="n">MoleculeDict</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">cure_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CURE&#39;</span><span class="p">,{})</span>
        <span class="k">if</span> <span class="n">cure_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting up cure controller&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">=</span><span class="n">CureController</span><span class="p">(</span><span class="n">cure_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ncpu&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>

<div class="viewcode-block" id="Runtime.generate_molecules"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.generate_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">generate_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">force_parameterization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">force_checkin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;generate_molecules manages creation and parameterization of all monomers</span>
<span class="sd">        and oligomer templates</span>

<span class="sd">        :param force_parameterization: forces AmberTools to run parameterizations, defaults to False</span>
<span class="sd">        :type force_parameterization: bool, optional</span>
<span class="sd">        :param force_checkin: forces HTPolyNet to overwrite molecule library, defaults to False</span>
<span class="sd">        :type force_checkin: bool, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">GAFF_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GAFF&#39;</span><span class="p">,{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">=</span><span class="p">{}</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; configuration.parse() generated a list of Molecules implied by configuration; assume</span>
<span class="sd">            they are all unparameterized &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">mname</span><span class="p">,</span><span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="s1">&#39;unparameterized&#39;</span><span class="p">)</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="s1">&#39;molecules/parameterized&#39;</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Templates in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Each molecule implied by the cfg is &#39;generated&#39; here, either by</span>
<span class="sd">            reading from the library or direct parameterization.  In some cases,</span>
<span class="sd">            the molecule is to be generated by a reaction; if so, it&#39;s</span>
<span class="sd">            `generator` attribute will be a Reaction instance &#39;&#39;&#39;</span>
        <span class="n">ess</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;s&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="si">}</span><span class="s1"> molecule</span><span class="si">{</span><span class="n">ess</span><span class="si">}</span><span class="s1"> detected in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">replns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">:</span><span class="s1">&gt;30s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s1">&lt;5d</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">msg</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecule_report</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">replns</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
        <span class="n">ml</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating: </span><span class="si">{</span><span class="n">ml</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mname</span><span class="p">,</span><span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_molecule</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">force_parameterization</span><span class="o">=</span><span class="n">force_parameterization</span><span class="p">,</span><span class="n">force_checkin</span><span class="o">=</span><span class="n">force_checkin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span><span class="o">=</span><span class="n">M</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Generate any required template products that result from reactions in which the bond generated creates</span>
<span class="sd">            dihedrals that span more than just the two monomers that are connected &#39;&#39;&#39;</span>
        <span class="n">new_reactions</span><span class="p">,</span><span class="n">new_molecules</span><span class="o">=</span><span class="n">chain_expand_reactions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_molecules</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ess</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_molecules</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;s&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_molecules</span><span class="p">)</span><span class="si">}</span><span class="s1"> molecule</span><span class="si">{</span><span class="n">ess</span><span class="si">}</span><span class="s1"> implied by chaining&#39;</span><span class="p">)</span>
            <span class="n">ml</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_molecules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># logger.info(ml)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_reactions</span><span class="p">)</span>
            <span class="n">make_molecules</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">new_molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">mname</span><span class="p">,</span><span class="n">M</span> <span class="ow">in</span> <span class="n">make_molecules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># logger.debug(f&#39;Generating {mname}:&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_molecule</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">force_parameterization</span><span class="o">=</span><span class="n">force_parameterization</span><span class="p">,</span><span class="n">force_checkin</span><span class="o">=</span><span class="n">force_checkin</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">M</span><span class="o">.</span><span class="n">get_origin</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;unparameterized&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span><span class="o">=</span><span class="n">M</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">M</span><span class="p">]</span><span class="o">.</span><span class="n">is_reactant</span><span class="o">=</span><span class="n">is_reactant</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">reactions</span><span class="p">,</span><span class="n">stage</span><span class="o">=</span><span class="n">reaction_stage</span><span class="o">.</span><span class="n">cure</span><span class="p">)</span>

        <span class="n">resolve_type_discrepancies</span><span class="o">=</span><span class="n">GAFF_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolve_type_discrepancies&#39;</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolve_type_discrepancies</span><span class="p">:</span>
            <span class="n">resolve_type_discrepancies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolve_type_discrepancies&#39;</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="n">resolve_type_discrepancies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resolve_directive</span> <span class="ow">in</span> <span class="n">resolve_type_discrepancies</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resolving type discrepancies for directive </span><span class="si">{</span><span class="n">resolve_directive</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_type_consistency_check</span><span class="p">(</span><span class="n">typename</span><span class="o">=</span><span class="n">resolve_directive</span><span class="p">[</span><span class="s1">&#39;typename&#39;</span><span class="p">],</span><span class="n">funcidx</span><span class="o">=</span><span class="n">resolve_directive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;funcidx&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">selection_rule</span><span class="o">=</span><span class="n">resolve_directive</span><span class="p">[</span><span class="s1">&#39;rule&#39;</span><span class="p">])</span>

        <span class="n">ess</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;s&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="si">}</span><span class="s1"> molecule template</span><span class="si">{</span><span class="n">ess</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_composition</span><span class="p">:</span> 
            <span class="n">cmp_msg</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;molecule&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_composition</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initial composition is </span><span class="si">{</span><span class="n">cmp_msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">calculate_maximum_conversion</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;100% conversion is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">maxconv</span><span class="si">}</span><span class="s1"> bonds&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reaction bond(s) in each molecular template:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">reaction_bonds</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bond </span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">reaction_bonds</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bond template(s) in each molecular template:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">bond_templates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Template </span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">bond_templates</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;constituents&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">relaxdict</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax&#39;</span><span class="p">,{})</span>
            <span class="k">if</span> <span class="n">relaxdict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">relaxdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Runtime.do_initialization"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_initialization">[docs]</a>    <span class="nd">@cp</span><span class="o">.</span><span class="n">enableCheckpoint</span>
    <span class="k">def</span> <span class="nf">do_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inpfnm</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_initialization manages creation of the global system topology file</span>
<span class="sd">        and the execution of &#39;gmx insert-molecules&#39; to create the initial</span>
<span class="sd">        simulation box</span>

<span class="sd">        :param inpfnm: basename for output files, defaults to &#39;init&#39;</span>
<span class="sd">        :type inpfnm: str, optional</span>
<span class="sd">        :return: dictionary of Gromacs files</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initialization in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialize_topology</span><span class="p">(</span><span class="n">inpfnm</span><span class="p">)</span>
        <span class="n">gro</span><span class="p">,</span><span class="n">grx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialize_coordinates</span><span class="p">(</span><span class="n">inpfnm</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">top</span><span class="p">,</span><span class="s1">&#39;gro&#39;</span><span class="p">:</span><span class="n">gro</span><span class="p">,</span><span class="s1">&#39;grx&#39;</span><span class="p">:</span><span class="n">grx</span><span class="p">}</span></div>

<div class="viewcode-block" id="Runtime.do_densification"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_densification">[docs]</a>    <span class="nd">@cp</span><span class="o">.</span><span class="n">enableCheckpoint</span>
    <span class="k">def</span> <span class="nf">do_densification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;densified&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_densification manages execution of gmx mdrun to perform minimization</span>
<span class="sd">            and NPT MD simulation of the initial liquid system.  Final coordinates are</span>
<span class="sd">            loaded into the global TopoCoord.</span>

<span class="sd">        :param inpfnm: input file name prefix, defaults to &#39;init&#39;</span>
<span class="sd">        :type inpfnm: str, optional</span>
<span class="sd">        :param deffnm: deffnm prefix fed to gmx mdrun, defaults to &#39;npt-1&#39;</span>
<span class="sd">        :type deffnm: str, optional</span>
<span class="sd">        :return: dictionary of Gromacs file names</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Densification in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">densification_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;densification&#39;</span><span class="p">,{})</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">densification_dict</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;&quot;densification&quot; directives missing&#39;</span>
        <span class="n">equilibration</span><span class="o">=</span><span class="n">densification_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;equilibration&#39;</span><span class="p">,[])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">equilibration</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;equilibration directives missing&#39;</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">infiles</span><span class="o">=</span><span class="p">[</span><span class="n">TC</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gro&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;grx&#39;</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">]),</span><span class="sa">f</span><span class="s1">&#39;One or more of </span><span class="si">{</span><span class="n">infiles</span><span class="si">}</span><span class="s1"> not found&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_equilibration_series</span><span class="p">(</span><span class="n">equilibration</span><span class="p">,</span><span class="n">deffnm</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">deffnm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">plot_pfx</span><span class="o">=</span><span class="s1">&#39;densification&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Densified coordinates in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">TC</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;gro&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">TC</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">!=</span><span class="s1">&#39;mol2&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Runtime.do_precure"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_precure">[docs]</a>    <span class="nd">@cp</span><span class="o">.</span><span class="n">enableCheckpoint</span>
    <span class="k">def</span> <span class="nf">do_precure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_precure manages execution of mdrun to perform any pre-cure MD simulation(s).</span>

<span class="sd">        :return: dictionary of Gromacs file names</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_pap</span><span class="p">(</span><span class="n">pfx</span><span class="o">=</span><span class="s1">&#39;precure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">!=</span><span class="s1">&#39;mol2&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Runtime.do_cure"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_cure">[docs]</a>    <span class="k">def</span> <span class="nf">do_cure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_cure manages CURE algorithm execution.</span>

<span class="sd">        :return: only returns None if CURE cannot execute</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;cc&#39;</span><span class="p">):</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no cure controller&#39;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># no cure controller</span>
        <span class="n">cc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">RL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">reactions</span>
        <span class="n">MD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">gromacs_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gromacs&#39;</span><span class="p">,{})</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_proj</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; read cure state or initialize new cure &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;systems/cure_state.yaml&#39;</span><span class="p">):</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">=</span><span class="n">CureState</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="s1">&#39;systems/cure_state.yaml&#39;</span><span class="p">)</span>
            <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connect-Update-Relax-Equilibrate (CURE) resumes&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;at iteration </span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">iter</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">cum_nxlinkbonds</span><span class="si">}</span><span class="s1"> bonds&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">max_nxlinkbonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">maxconv</span><span class="p">,</span><span class="n">desired_nxlinkbonds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">maxconv</span><span class="o">*</span><span class="n">cc</span><span class="o">.</span><span class="n">dicts</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="s1">&#39;desired_conversion&#39;</span><span class="p">]),</span><span class="n">max_search_radius</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">TC</span><span class="o">.</span><span class="n">Coordinates</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">iter</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">my_logger</span><span class="p">(</span><span class="s1">&#39;Connect-Update-Relax-Equilibrate (CURE) begins&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">cure_finished</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">is_cured</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cure_finished</span><span class="p">:</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cure finished even before loop&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; perform CURE iterations &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempting to form </span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">desired_nxlinkbonds</span><span class="si">}</span><span class="s1"> bonds&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">cure_finished</span><span class="p">:</span>
            <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/iter-</span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">do_iter</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="n">RL</span><span class="p">,</span><span class="n">MD</span><span class="p">,</span><span class="n">gromacs_dict</span><span class="o">=</span><span class="n">gromacs_dict</span><span class="p">)</span>
            <span class="n">cure_finished</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">is_cured</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cure_finished</span><span class="p">:</span>
                <span class="n">cure_finished</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">next_iter</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; perform capping if necessary &#39;&#39;&#39;</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Capping begins&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/capping&#39;</span><span class="p">)</span>
        <span class="n">cc</span><span class="o">.</span><span class="n">do_capping</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="n">RL</span><span class="p">,</span><span class="n">MD</span><span class="p">,</span><span class="n">gromacs_dict</span><span class="o">=</span><span class="n">gromacs_dict</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="s1">&#39;Connect-Update-Relax-Equilibrate (CURE) ends&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="Runtime.do_postcure"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_postcure">[docs]</a>    <span class="nd">@cp</span><span class="o">.</span><span class="n">enableCheckpoint</span>
    <span class="k">def</span> <span class="nf">do_postcure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_postcure manages execution of mdrun to perform any post-cure MD simulation(s).</span>

<span class="sd">        :return: dictionary of Gromacs file names</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_pap</span><span class="p">(</span><span class="n">pfx</span><span class="o">=</span><span class="s1">&#39;postcure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">!=</span><span class="s1">&#39;mol2&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Runtime.save_data"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.save_data">[docs]</a>    <span class="nd">@cp</span><span class="o">.</span><span class="n">enableCheckpoint</span>
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result_name</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;save_data writes &#39;gro&#39;, &#39;top&#39;, and &#39;grx&#39; files for system</span>

<span class="sd">        :param result_name: output file basename, defaults to &#39;final&#39;</span>
<span class="sd">        :type result_name: str, optional</span>
<span class="sd">        :return: dictionary of Gromacs file basenames</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final data to </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">write_grx_attributes</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s1">.grx&#39;</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">write_gro</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">write_top</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s1">.top&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">TC</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">!=</span><span class="s1">&#39;mol2&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Runtime.do_workflow"><a class="viewcode-back" href="../../HTPolyNetPackage.html#HTPolyNet.runtime.Runtime.do_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">do_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do_workflow manages runtime for one entire system-build workflow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">force_parameterization</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_parameterization&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">force_checkin</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_checkin&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_proj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_molecules</span><span class="p">(</span>
            <span class="n">force_parameterization</span><span class="o">=</span><span class="n">force_parameterization</span><span class="p">,</span>  <span class="c1"># force antechamber/GAFF parameterization</span>
            <span class="n">force_checkin</span><span class="o">=</span><span class="n">force_checkin</span>                     <span class="c1"># force check-in to system libraries</span>
        <span class="p">)</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_proj</span><span class="p">()</span>
        <span class="n">last_data</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">read_checkpoint</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checkpoint last_data </span><span class="si">{</span><span class="n">last_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">last_data</span><span class="p">)</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/init&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_initialization</span><span class="p">()</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/densification&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_densification</span><span class="p">()</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/precure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_precure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_cure</span><span class="p">()</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/postcure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_postcure</span><span class="p">()</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_to</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;systems/final-results&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">go_proj</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_generate_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">M</span><span class="p">:</span><span class="n">Molecule</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_generate_molecule generates and parameterizes a single molecule based on the partially </span>
<span class="sd">        complete instance in parameter M</span>

<span class="sd">        :param M: partially-complete molecule instance (populated by config reader)</span>
<span class="sd">        :type M: Molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">origin</span><span class="o">!=</span><span class="s1">&#39;unparameterized&#39;</span> <span class="ow">and</span> <span class="n">M</span><span class="o">.</span><span class="n">origin</span><span class="o">!=</span><span class="s1">&#39;symmetry_product&#39;</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">mname</span><span class="o">=</span><span class="n">M</span><span class="o">.</span><span class="n">name</span>
        <span class="n">checkin</span><span class="o">=</span><span class="n">pfs</span><span class="o">.</span><span class="n">checkin</span>
        <span class="n">force_parameterization</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_parameterization&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">force_checkin</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_checkin&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Either perform a fresh parameterization or fetch parameterization files &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">force_parameterization</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">M</span><span class="o">.</span><span class="n">previously_parameterized</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Parameterization of </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1"> requested -- can we generate </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">?&#39;</span><span class="p">)</span>
            <span class="n">generatable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">reactants</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
            <span class="k">if</span> <span class="n">generatable</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">M</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">available_molecules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mol2&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;itp&#39;</span><span class="p">,</span><span class="s1">&#39;gro&#39;</span><span class="p">,</span><span class="s1">&#39;grx&#39;</span><span class="p">]:</span>
                    <span class="n">checkin</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;molecules/parameterized/</span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">force_checkin</span><span class="p">)</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="s1">&#39;newly parameterized&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: could not generate </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;not (</span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">.generator) = </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;reactants </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">reactants</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetching parameterized </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">exts</span><span class="o">=</span><span class="n">pfs</span><span class="o">.</span><span class="n">fetch_molecule_files</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fetched </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1"> exts </span><span class="si">{</span><span class="n">exts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">M</span><span class="o">.</span><span class="n">load_top_gro</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">.top&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">,</span><span class="n">mol2filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wrap_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">M</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">read_gro_attributes</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s1">.grx&#39;</span><span class="p">)</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set_sequence_from_coordinates</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">generator</span><span class="p">:</span>
                <span class="n">M</span><span class="o">.</span><span class="n">prepare_new_bonds</span><span class="p">(</span><span class="n">available_molecules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="s1">&#39;previously parameterized&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Generate any stereoisomers and/or conformers &#39;&#39;&#39;</span>
        <span class="n">M</span><span class="o">.</span><span class="n">generate_stereoisomers</span><span class="p">()</span>
        <span class="n">M</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_type_consistency_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">typename</span><span class="o">=</span><span class="s1">&#39;dihedraltypes&#39;</span><span class="p">,</span><span class="n">funcidx</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">selection_rule</span><span class="o">=</span><span class="s1">&#39;stiffest&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_type_consistency_check checks current topology for any inconsistencies and corrects them</span>

<span class="sd">        :param typename: type of Gromacs interaction to check, defaults to &#39;dihedraltypes&#39;</span>
<span class="sd">        :type typename: str, optional</span>
<span class="sd">        :param funcidx: function type of interaction, defaults to 4</span>
<span class="sd">        :type funcidx: int, optional</span>
<span class="sd">        :param selection_rule: one-word designation for correction mechanism, defaults to &#39;stiffest&#39;</span>
<span class="sd">        :type selection_rule: str, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Consistency check of </span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s1"> func </span><span class="si">{</span><span class="n">funcidx</span><span class="si">}</span><span class="s1"> on all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span><span class="si">}</span><span class="s1"> molecules requested&#39;</span><span class="p">)</span>
        <span class="n">mnames</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">types_duplicated</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)):</span>
                <span class="n">mol1topo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">Topology</span>
                <span class="n">mol2topo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mnames</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">Topology</span>
                <span class="n">this_duptypes</span><span class="o">=</span><span class="n">mol1topo</span><span class="o">.</span><span class="n">report_duplicate_types</span><span class="p">(</span><span class="n">mol2topo</span><span class="p">,</span><span class="n">typename</span><span class="o">=</span><span class="n">typename</span><span class="p">,</span><span class="n">funcidx</span><span class="o">=</span><span class="n">funcidx</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;...</span><span class="si">{</span><span class="n">mnames</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">this_duptypes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">this_duptypes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">types_duplicated</span><span class="p">:</span>
                        <span class="n">types_duplicated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Duplicated </span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">types_duplicated</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types_duplicated</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Duplicate </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)):</span>
                <span class="n">moltopo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">Topology</span>
                <span class="n">this_type</span><span class="o">=</span><span class="n">moltopo</span><span class="o">.</span><span class="n">report_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">typename</span><span class="o">=</span><span class="s1">&#39;dihedraltypes&#39;</span><span class="p">,</span><span class="n">funcidx</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_type</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">this_type</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_type</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> reports </span><span class="si">{</span><span class="n">this_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conflicting options for this type: </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">selected_type</span><span class="o">=</span><span class="n">select_topology_type_option</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">typename</span><span class="p">,</span><span class="n">rule</span><span class="o">=</span><span class="n">selection_rule</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Under selection rule &quot;</span><span class="si">{</span><span class="n">selection_rule</span><span class="si">}</span><span class="s1">&quot;, preferred type is </span><span class="si">{</span><span class="n">selected_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resetting </span><span class="si">{</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">mnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">TopoCoord</span>
                <span class="n">moltopo</span><span class="o">=</span><span class="n">TC</span><span class="o">.</span><span class="n">Topology</span>
                <span class="n">moltopo</span><span class="o">.</span><span class="n">reset_type</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">selected_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inpfnm</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_initialize_topology creates a full gromacs topology that includes all directives necessary</span>
<span class="sd">            for an initial liquid simulation.  This will NOT use any #include&#39;s;</span>
<span class="sd">            all types will be explicitly in-lined.</span>

<span class="sd">        :param inpfnm: input file basename, defaults to &#39;init&#39;</span>
<span class="sd">        :type inpfnm: str, optional</span>
<span class="sd">        :return: name of top file</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if cp.passed(&#39;initialize_topology&#39;): return</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.top&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.top already exists in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1"> but we will rebuild it anyway!&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; for each monomer named in the cfg, either parameterize it or fetch its parameterization &#39;&#39;&#39;</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">already_merged</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_composition</span><span class="p">:</span>
            <span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;molecule&#39;</span><span class="p">]]</span>
            <span class="n">N</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">t</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">Topology</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Merging </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1"> copies of </span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">s topology into global topology&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">adjust_charges</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="s1">&#39;nr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span><span class="n">desired_charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">overcharge_threshhold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rep_ex</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">TC</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">already_merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">othermol</span><span class="p">,</span><span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">othermol</span> <span class="ow">in</span> <span class="n">already_merged</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Merging types from </span><span class="si">{</span><span class="n">othermol</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">s topology into global topology&#39;</span><span class="p">)</span>
                <span class="n">TC</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">merge_types</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">TopoCoord</span><span class="o">.</span><span class="n">Topology</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Topology &quot;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.top&quot; in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">write_top</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.top&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.top&#39;</span>

    <span class="k">def</span> <span class="nf">_initialize_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inpfnm</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_initialize_coordinates builds initial top and gro files for initial liquid simulation</span>

<span class="sd">        :param inpfnm: input file basename, defaults to &#39;init&#39;</span>
<span class="sd">        :type inpfnm: str, optional</span>
<span class="sd">        :return: &#39;gro&#39; and &#39;grx&#39; file names</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">densification_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;densification&#39;</span><span class="p">,{})</span>
        <span class="c1"># logger.debug(f&#39;{densification_dict}&#39;)</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">densification_dict</span><span class="p">:</span>
            <span class="n">densification_dict</span><span class="p">[</span><span class="s1">&#39;aspect_ratio&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aspect_ratio&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]))</span>
            <span class="k">if</span> <span class="s1">&#39;initial_density&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">densification_dict</span><span class="p">[</span><span class="s1">&#39;initial_density&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial_density&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;initial_boxsize&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">densification_dict</span><span class="p">[</span><span class="s1">&#39;initial_boxsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial_boxsize&#39;</span><span class="p">]</span>
        <span class="n">dspec</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;initial_density&#39;</span> <span class="ow">in</span> <span class="n">densification_dict</span><span class="p">,</span><span class="s1">&#39;initial_boxsize&#39;</span> <span class="ow">in</span> <span class="n">densification_dict</span><span class="p">]</span>
        <span class="c1"># logger.debug(f&#39;{dspec} {any(dspec)} {not all(dspec)}&#39;)</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">dspec</span><span class="p">),</span><span class="s1">&#39;Neither &quot;initial_boxsize&quot; nor &quot;initial_density&quot; are specfied&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dspec</span><span class="p">),</span><span class="s1">&#39;Cannot specify both &quot;initial_boxsize&quot; and &quot;initial_density&quot;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;initial_boxsize&#39;</span> <span class="ow">in</span> <span class="n">densification_dict</span><span class="p">:</span>
            <span class="n">boxsize</span><span class="o">=</span><span class="n">densification_dict</span><span class="p">[</span><span class="s1">&#39;initial_boxsize&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass_kg</span><span class="o">=</span><span class="n">TC</span><span class="o">.</span><span class="n">total_mass</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;SI&#39;</span><span class="p">)</span>
            <span class="n">V0_m3</span><span class="o">=</span><span class="n">mass_kg</span><span class="o">/</span><span class="n">densification_dict</span><span class="p">[</span><span class="s1">&#39;initial_density&#39;</span><span class="p">]</span>
            <span class="n">ar</span><span class="o">=</span><span class="n">densification_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aspect_ratio&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">ar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mf">1.</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;Error: parameter aspect_ratio must be a 3-element-list with first element 1&#39;</span>
            <span class="n">ar_yx</span><span class="o">=</span><span class="n">ar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">L0_m</span><span class="o">=</span><span class="p">(</span><span class="n">V0_m3</span><span class="o">/</span><span class="n">ar_yx</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
            <span class="n">L0_nm</span><span class="o">=</span><span class="n">L0_m</span><span class="o">*</span><span class="mf">1.e9</span>
            <span class="n">boxsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">L0_nm</span><span class="p">,</span><span class="n">L0_nm</span><span class="p">,</span><span class="n">L0_nm</span><span class="p">])</span><span class="o">*</span><span class="n">ar</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initial density: </span><span class="si">{</span><span class="n">densification_dict</span><span class="p">[</span><span class="s2">&quot;initial_density&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> kg/m^3&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total mass: </span><span class="si">{</span><span class="n">mass_kg</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1"> kg&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Box aspect ratio: </span><span class="si">{</span><span class="s2">&quot; x &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ar</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initial box side lengths: </span><span class="si">{</span><span class="n">boxsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> nm x </span><span class="si">{</span><span class="n">boxsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> nm x </span><span class="si">{</span><span class="n">boxsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> nm&#39;</span><span class="p">)</span>

        <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="n">cc</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_composition</span> <span class="k">if</span> <span class="s1">&#39;count&#39;</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">]</span>
        <span class="n">c_togromacs</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">:</span>
            <span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">cc</span><span class="p">[</span><span class="s1">&#39;molecule&#39;</span><span class="p">]]</span>
            <span class="n">tc</span><span class="o">=</span><span class="n">cc</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tc</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nconf</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tc</span><span class="o">&lt;</span><span class="n">nconf</span><span class="p">:</span>
                    <span class="n">c_togromacs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">u</span><span class="p">:</span><span class="mi">1</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span><span class="n">tc</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="nb">divmod</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span><span class="n">nconf</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;divmod(</span><span class="si">{</span><span class="n">nconf</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">tc</span><span class="si">}</span><span class="s1">) gives </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">c_togromacs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">u</span><span class="p">:</span><span class="n">q</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">})</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">while</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">c_togromacs</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">r</span><span class="o">-=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">gro</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">conformers</span><span class="p">:</span>
                    <span class="n">pfs</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;molecules/parameterized/</span><span class="si">{</span><span class="n">gro</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">,</span><span class="n">altpath</span><span class="o">=</span><span class="p">[</span><span class="n">pfs</span><span class="o">.</span><span class="n">subpath</span><span class="p">(</span><span class="s1">&#39;molecules&#39;</span><span class="p">)])</span>        
            <span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; assuming racemic mixture of any stereoisomers &#39;&#39;&#39;</span>
                <span class="n">total_isomers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">stereoisomers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">count_per_isomer</span><span class="o">=</span><span class="n">tc</span><span class="o">//</span><span class="n">total_isomers</span>
                <span class="n">leftovers</span><span class="o">=</span><span class="n">tc</span><span class="o">%</span><span class="n">total_isomers</span>
                <span class="n">c_togromacs</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">count_per_isomer</span>
                <span class="k">if</span> <span class="n">leftovers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">c_togromacs</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">leftovers</span><span class="o">-=</span><span class="mi">1</span>
                <span class="n">pfs</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;molecules/parameterized/</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">,</span><span class="n">altpath</span><span class="o">=</span><span class="p">[</span><span class="n">pfs</span><span class="o">.</span><span class="n">subpath</span><span class="p">(</span><span class="s1">&#39;molecules&#39;</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">stereoisomers</span><span class="p">:</span>
                    <span class="n">c_togromacs</span><span class="p">[</span><span class="n">isomer</span><span class="p">]</span><span class="o">=</span><span class="n">count_per_isomer</span>
                    <span class="k">if</span> <span class="n">leftovers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">c_togromacs</span><span class="p">[</span><span class="n">isomer</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">leftovers</span><span class="o">-=</span><span class="mi">1</span>
                    <span class="n">pfs</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;molecules/parameterized/</span><span class="si">{</span><span class="n">isomer</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">,</span><span class="n">altpath</span><span class="o">=</span><span class="p">[</span><span class="n">pfs</span><span class="o">.</span><span class="n">subpath</span><span class="p">(</span><span class="s1">&#39;molecules&#39;</span><span class="p">)])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending to insert_molecules: </span><span class="si">{</span><span class="n">c_togromacs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">insert_molecules</span><span class="p">(</span><span class="n">c_togromacs</span><span class="p">,</span><span class="n">boxsize</span><span class="p">,</span><span class="n">inpfnm</span><span class="p">,</span><span class="n">inputs_dir</span><span class="o">=</span><span class="s1">&#39;../../molecules/parameterized&#39;</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">read_gro</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">atom_count</span><span class="p">()</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">set_grx_attributes</span><span class="p">()</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">inherit_grx_attributes_from_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_composition</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">list_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">]:</span>
            <span class="n">TC</span><span class="o">.</span><span class="n">reset_idx_list_from_grx_attributes</span><span class="p">(</span><span class="n">list_name</span><span class="p">)</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">make_resid_graph</span><span class="p">()</span>
        <span class="n">TC</span><span class="o">.</span><span class="n">write_grx_attributes</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.grx&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Coordinates &quot;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.gro&quot; in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extended attributes &quot;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.grx&quot; in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inpfnm</span><span class="si">}</span><span class="s1">.grx&#39;</span>

    <span class="k">def</span> <span class="nf">_do_equilibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">edict</span><span class="o">=</span><span class="p">{},</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;equilibrate&#39;</span><span class="p">,</span><span class="n">plot_pfx</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_do_equilibration manages execution of TopoCoord.equilibrate using</span>
<span class="sd">        the directive passed in parameter &#39;edict&#39;</span>

<span class="sd">        :param edict: equilibration directives, defaults to {}</span>
<span class="sd">        :type edict: dict, optional</span>
<span class="sd">        :param deffnm: mdrun default file basename, defaults to &#39;equilibrate&#39;</span>
<span class="sd">        :type deffnm: str, optional</span>
<span class="sd">        :param plot_pfx: basename for any output plots, defaults to &#39;&#39;</span>
<span class="sd">        :type plot_pfx: str, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gromacs_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gromacs&#39;</span><span class="p">,{})</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">edict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_edict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ignoring unknown equilibration directive &quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">edr_list</span><span class="o">=</span><span class="n">TC</span><span class="o">.</span><span class="n">equilibrate</span><span class="p">(</span><span class="n">deffnm</span><span class="p">,</span><span class="n">edict</span><span class="p">,</span><span class="n">gromacs_dict</span><span class="p">)</span>
        <span class="n">ens</span><span class="o">=</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ens</span><span class="o">==</span><span class="s1">&#39;npt&#39;</span> <span class="ow">and</span> <span class="n">plot_pfx</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span><span class="n">edr_list</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pfs</span><span class="o">.</span><span class="n">proj</span><span class="p">(),</span><span class="sa">f</span><span class="s1">&#39;plots/</span><span class="si">{</span><span class="n">plot_pfx</span><span class="si">}</span><span class="s1">-density.png&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_do_equilibration_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eq_stgs</span><span class="o">=</span><span class="p">[],</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;equilibrate&#39;</span><span class="p">,</span><span class="n">plot_pfx</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_do_equilibration_series manages a series of equilibrations</span>

<span class="sd">        :param eq_stgs: list of stage designations, defaults to []</span>
<span class="sd">        :type eq_stgs: list, optional</span>
<span class="sd">        :param deffnm: mdrun default file basename, defaults to &#39;equilibrate&#39;</span>
<span class="sd">        :type deffnm: str, optional</span>
<span class="sd">        :param plot_pfx: basename for any output plots, defaults to &#39;&#39;</span>
<span class="sd">        :type plot_pfx: str, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq_stgs</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">stg</span> <span class="ow">in</span> <span class="n">eq_stgs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_equilibration</span><span class="p">(</span><span class="n">stg</span><span class="p">,</span><span class="n">deffnm</span><span class="p">,</span><span class="n">plot_pfx</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">_do_pap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pfx</span><span class="o">=</span><span class="s1">&#39;precure&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_do_pap manages a preanneal-anneal-postanneal series of MD simulations</span>

<span class="sd">        :param pfx: either &#39;precure&#39; or &#39;postcure&#39;, defaults to &#39;precure&#39;</span>
<span class="sd">        :type pfx: str, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pfx</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">assert</span> <span class="n">pfx</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;precure&#39;</span><span class="p">,</span><span class="s1">&#39;postcure&#39;</span><span class="p">]</span>
        <span class="n">pap_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pfx</span><span class="p">,{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pap_dict</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">preequil</span><span class="o">=</span><span class="n">pap_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preequilibration&#39;</span><span class="p">,{})</span>
        <span class="n">anneal</span><span class="o">=</span><span class="n">pap_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anneal&#39;</span><span class="p">,{})</span>
        <span class="n">postequil</span><span class="o">=</span><span class="n">pap_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;postequilibration&#39;</span><span class="p">,{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">preequil</span><span class="p">,</span><span class="n">anneal</span><span class="p">,</span><span class="n">postequil</span><span class="p">]):</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_nonempty_directives</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">preequil</span><span class="p">,</span><span class="n">anneal</span><span class="p">,</span><span class="n">postequil</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">]):</span> <span class="k">return</span>
        <span class="n">my_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfx</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">pfs</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">preequil</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_equilibration</span><span class="p">(</span><span class="n">preequil</span><span class="p">,</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;preequilibration&#39;</span><span class="p">,</span><span class="n">plot_pfx</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfx</span><span class="si">}</span><span class="s1">-preequilibration&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anneal</span> <span class="ow">and</span> <span class="n">_nonempty_directives</span><span class="p">([</span><span class="n">anneal</span><span class="p">]):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_anneal</span><span class="p">(</span><span class="n">anneal</span><span class="p">,</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;annealed&#39;</span><span class="p">)</span>
            <span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,[</span><span class="s1">&#39;annealed&#39;</span><span class="p">],</span><span class="n">outfile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pfs</span><span class="o">.</span><span class="n">proj</span><span class="p">(),</span><span class="sa">f</span><span class="s1">&#39;plots/</span><span class="si">{</span><span class="n">pfx</span><span class="si">}</span><span class="s1">-anneal-T.png&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">postequil</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_equilibration</span><span class="p">(</span><span class="n">postequil</span><span class="p">,</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;postequilibration&#39;</span><span class="p">,</span><span class="n">plot_pfx</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pfx</span><span class="si">}</span><span class="s1">-postequilibration&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_anneal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">anneal_dict</span><span class="o">=</span><span class="p">{},</span><span class="n">deffnm</span><span class="o">=</span><span class="s1">&#39;anneal&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_do_anneal manages execution of an annealing MD simulation</span>

<span class="sd">        :param anneal_dict: annealing directives, defaults to {}</span>
<span class="sd">        :type anneal_dict: dict, optional</span>
<span class="sd">        :param deffnm: mdrun default file basename, defaults to &#39;anneal&#39;</span>
<span class="sd">        :type deffnm: str, optional</span>
<span class="sd">        :raises Exception: If no run duration is indicated in the any of the annealing segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anneal_dict</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">ncycles</span><span class="o">=</span><span class="n">anneal_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ncycles&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncycles</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">mdp_pfx</span><span class="o">=</span><span class="s1">&#39;nvt&#39;</span> <span class="c1"># assume all annealing run at NVT</span>
        <span class="n">TC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TopoCoord</span>
        <span class="n">gromacs_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gromacs&#39;</span><span class="p">,{})</span>
        <span class="n">pfs</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mdp/</span><span class="si">{</span><span class="n">mdp_pfx</span><span class="si">}</span><span class="s1">.mdp&#39;</span><span class="p">)</span>
        <span class="n">timestep</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">mdp_get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mdp_pfx</span><span class="si">}</span><span class="s1">.mdp&#39;</span><span class="p">,</span><span class="s1">&#39;dt&#39;</span><span class="p">))</span>
        <span class="n">cycle_segments</span><span class="o">=</span><span class="n">anneal_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cycle_segments&#39;</span><span class="p">,[])</span>
        <span class="n">temps</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cycle_segments</span><span class="p">]</span>
        <span class="n">durations</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cycle_segments</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">durations</span><span class="p">):</span>
            <span class="n">durations</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nsteps&#39;</span><span class="p">,)</span><span class="o">*</span><span class="n">timestep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cycle_segments</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">durations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No &quot;ps&quot; or &quot;nsteps&quot; found.&#39;</span><span class="p">)</span>
        <span class="n">cycle_duration</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
        <span class="n">total_duration</span><span class="o">=</span><span class="n">cycle_duration</span><span class="o">*</span><span class="n">ncycles</span>
        <span class="n">nsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total_duration</span><span class="o">/</span><span class="n">timestep</span><span class="p">)</span>
        <span class="n">cum_time</span><span class="o">=</span><span class="n">durations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cum_time</span><span class="p">)):</span>
            <span class="n">cum_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="n">cum_time</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annealing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span><span class="si">}</span><span class="s1"> points for </span><span class="si">{</span><span class="n">ncycles</span><span class="si">}</span><span class="s1"> cycles over </span><span class="si">{</span><span class="n">total_duration</span><span class="si">}</span><span class="s1"> ps&#39;</span><span class="p">)</span>
        <span class="n">mod_dict</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;ref_t&#39;</span><span class="p">:</span><span class="n">anneal_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_temperature&#39;</span><span class="p">,</span><span class="mf">300.0</span><span class="p">),</span>
            <span class="s1">&#39;gen-temp&#39;</span><span class="p">:</span><span class="n">anneal_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_temperature&#39;</span><span class="p">,</span><span class="mf">300.0</span><span class="p">),</span>
            <span class="s1">&#39;gen-vel&#39;</span><span class="p">:</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annealing-npoints&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">cycle_segments</span><span class="p">),</span>
            <span class="s1">&#39;annealing-temp&#39;</span><span class="p">:</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temps</span><span class="p">),</span>
            <span class="s1">&#39;annealing-time&#39;</span><span class="p">:</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cum_time</span><span class="p">]),</span>
            <span class="s1">&#39;annealing&#39;</span><span class="p">:</span><span class="s1">&#39;periodic&#39;</span> <span class="k">if</span> <span class="n">ncycles</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nsteps&#39;</span><span class="p">:</span><span class="n">nsteps</span>
            <span class="p">}</span>
        <span class="n">mdp_modify</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mdp_pfx</span><span class="si">}</span><span class="s1">.mdp&#39;</span><span class="p">,</span><span class="n">mod_dict</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">TC</span><span class="o">.</span><span class="n">grompp_and_mdrun</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">deffnm</span><span class="p">,</span><span class="n">mdp</span><span class="o">=</span><span class="n">mdp_pfx</span><span class="p">,</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">gromacs_dict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annealed coordinates in </span><span class="si">{</span><span class="n">deffnm</span><span class="si">}</span><span class="s1">.gro&#39;</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">HTPolyNet</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation and Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example-tutorials/index.html">Example Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference-materials/index.html">Reference Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HTPolyNetPackage.html">HTPolyNet package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Cameron Abrams, Ming Huang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>