# HTPolyNet: High-Throughput Polymer Network Atomistic Simulations

Ming Huang and Cameron F Abrams

Drexel University

Department of Chemical and Biological Engineering

## Introduction

HTPolyNet is a utility for generating atomistic models of cross-linked polymer networks together with appropriate topology and parameter files required for molecular dynamics simulations using Gromacs.  It is intended as a fully automated system builder requiring as inputs only the molecular structures of any monomer species, a description of the polymerization chemistry, and a handful of options describing primarily the desired system size and composition.

HTPolyNet uses the Generalized Amber Force Field for atom-typing and parameter generation.

## Software Prerequisites
* [AmberTools19](https://ambermd.org/GetAmber.php#ambertools)
  - Options:
     * conda: `conda install -c ambermd ambertools` installs precompiled executables for ambertools into your Anaconda environment
     * compile from source:
       ```
       tar jxf AmberTools20.tar.bz2
       cd amber_src
       ./configure gnu
       source amber.sh
       make install
       ```
  - The specific executables needed are `antechamber`, `parmchk2`, and `tleap`
* [openbabel](http://openbabel.org/wiki/Category:Installation)
    - Options:
       * Install using package manager (Linux)
       * compile from source: (download tar file from the official website)
         ```
         tar zxf openbabel-2.3.2.tar.gz
         cd openbabel-2.3.2
         mkdir build
         cd build
         cmake ..
         make -j4
         make install
         ```
* [gromacs](https://manual.gromacs.org/documentation/2020/install-guide/index.html) v2016
  - Notes for 2016.6 on OpenSUSE Leap 15.2 with cuda 11 and openMPI:
    ```
    tar xfz gromacs-2016.6.tar.gz
    cd gromacs-2016.6
    mkdir build
    cd build
    cmake ..  -DGMX_BUILD_OWN_FFTW=ON -DREGRESSIONTEST_DOWNLOAD=ON -DGMX_MPI=on -DGMX_GPU=on -DCMAKE_INSTALL_PREFIX=/usr/local/gromacs-2016.6
    make
    make check
    sudo make install
    source /usr/local/gromacs-2016.6/bin/GMXRC  (added to ~/.bashrc)
    ```
  
* python3.x with the following modules (I'm using Anaconda)
  - numpy
  - pandas [ version > 1.0 ] 
  - scipy
  - parmed
    ```
    conda install -c omnia parmed
    ```
  - networkx
    ```
    conda install -c anaconda networkx
    ```

## Templates

* cfg:  These are example configuration files.
* Gromacs_mdp:  These are Gromacs input files
* mol2:  These are a selection of monomer structures

## Getting started

1. (one time) Clone this repository from github, and pip install
   ```
   git clone git@github.com:AbramsGroup/HTPolyNet.git
   cd HTPolyNet
   pip install .
   ```
2. Go to a fresh, empty directory somewhere, and issue the command 
   ```
   cd ~
   mkdir my_htpolynet_run
   htpolynet init
   ```
   This will create a set of subdirectories and generate a representative configuration file for you in the subdirectory `basic/`.  You can edit this file to customize your system generation.  More about the configuration files is in the next section.
   ```
   cd basic
   mv example.cfg my_run.cfg
   vi my_run.cfg
   ```
3. Launch HTPolyNet:
   ``` 
   htpolynet run my_run.cfg
   ```
   This will likely take some time.
4. Check the `results/` subdirectory.  Each system replica appears in a different subdirectory in `results/`.  A record of all bonds formed is in `bond.txt`. When one replica been finished, the final structure and topology appear in the `Final/` subdirectory. 

## Subdirectories generated by `htpolynet init` and `htpolynet run`

* `basic/`:  This folder contains two files. 
  - `<*.cfg>`:  Contains all configuration parameters for an HTPolyNet run; human-editable.
  - `charges.txt`: Atomic partial charge database; automatically generated by HTPolyNet. 
   
* `mdp/`: Necessary Gromacs input files for various minimization/MD simulations
  - `em.mdp`: minimization
  - `npt-init.mdp`: initial NPT MD to generate liquid state
  - `npt-sw.mdp`: stepwise NPT MD **to do something, I don't know what**
  - `npt-cl.mdp`: NPT MD in crosslinking algorithm
* `systems/`: 
  - `unrctSystem`: Raw mol2 files for unreacted monomers and their associated output from `antechamber` and `parmed`.
  - `typeSystem`: Working files resulting from atom charging calculations.
  - `rctSystem`: Structures of reacted oligomers and  and their associated output from `antechamber` and `parmed`.

## Configuration files

Configuration files for HTPolyNet are simple lines of the form `keyword = value`.  Below are some base-level examples. 

- Basic Information
  ```
  reProject = proj1  # If want to restart a proj folder, add this option otherwise, can 
                      # ignore this option 
  boxSize = 5        # Initial size of the system. If the box is not big enough
  cutoff = 0.5       # Initial cutoff for radius cutoff searching
  bondsRatio = 0.95  # Desired conversion 
  HTProcess = True   # If do the Head-Tail check 
  CPU = 32           # number of CPU used for MD simulation
  trials = 5         # Replica want to generate (Not gurantee all trials will goes to desired conversion)
  ```
- *boxSize*: If the box size is not big enough, not all molecules can be
  inserted to the box which may cause the algorithms cannot
  obtain expected number of molecules and force quit. 
  But if the box size is so large which will delay the 
  performance
  
- Molecules are separeted into two categories, crosslinker and monomer. Each 
  can have multiple molecules. 
  ```
  croName1 = VEA # Name should be consist with the mol2 name 
  ...
  
  croName2 = VEB
  ...
  
  monName1 = STYA
  ...
  
  monName2 = STYB
  
  ...
  ``` 
- Molecules' properties
  ```
  croName1 = VEA
  croNum1 = 4    # number of the molecules
  cro1R_list = C19, C20, C26, C27  # Unique atom names which defined in the mol2 file
  cro1R_rNum = 1, 1, 1, 1          # How many times that each atoms can be reacted
  cro1R_rct = H, T, H, T           # Atoms' head and tail properties 
  cro1R_group = 1, 1, 2, 2         # atoms group on the molecules 
  ```

- Reaction Information:
  Chemical mechanism of the system. In this part, list all potential reactions.
  Don't need to consider the sequence. 'VEA + VEB' is the same as 'VEB + VEA'.
  Add the reactivity probability at the end of each line
  ```
  VEA + VEA + 100.0%
  VEA + VEB + 100.0%
  ...
        ```
